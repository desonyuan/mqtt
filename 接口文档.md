# 农业物联网管理系统 API 文档

## 基本信息

- **基础URL**: `/api`
- **版本**: v1.0
- **格式**: JSON

## 错误处理

所有API请求在出错时都会返回一个标准的错误响应格式：

```json
{
  "error": "error_type"
}
```

常见错误类型：

| 错误类型 | HTTP状态码 | 说明 |
|---------|------------|------|
| `not_found` | 404 | 资源未找到 |
| `authentication_failed` | 401 | 认证失败 |
| `invalid_token` | 401 | 无效的JWT令牌 |
| `token_expired` | 401 | JWT令牌已过期 |
| `forbidden` | 403 | 权限不足 |
| `validation_error` | 400 | 输入验证失败 |
| `captcha_error` | 400 | 验证码错误 |
| `invalid_json` | 422 | JSON格式无效 |
| `invalid_form` | 422 | 表单无效 |
| `invalid_path` | 422 | 路径参数无效 |
| `invalid_query` | 422 | 查询参数无效 |
| `invalid_request` | 400 | 请求无效 |
| `database_error` | 500 | 数据库错误 |
| `username_exists` | 409 | 用户名已存在 |
| `invalid_user_type` | 400 | 用户类型无效 |
| `unique_violation` | 409 | 唯一约束冲突 |
| `redis_timeout` | 504 | Redis超时 |
| `redis_connection_error` | 503 | Redis连接错误 |
| `redis_io_error` | 500 | Redis IO错误 |
| `redis_error` | 500 | Redis通用错误 |
| `internal_server_error` | 500 | 服务器内部错误 |

## API 接口

### 1. 认证相关接口

#### 1.1 用户登录

- **URL**: `/login`
- **方法**: `POST`
- **描述**: 用户登录并获取JWT令牌
- **权限**: 无需认证

**请求格式**:
```json
{
  "username": "example_user",  // string: 用户名，长度4-20个字符
  "password_hash": "hashed_password_string",  // string: 密码哈希（前端计算的密码哈希值）
  "captcha_id": "16_character_id",  // string: 验证码ID，16个字符
  "captcha_code": "user_input_captcha"  // string: 用户输入的验证码，1-8个字符
}
```

**请求字段说明**:
- `username`: 用户名，长度4-20个字符
- `password_hash`: 密码哈希（前端计算的密码哈希值）
- `captcha_id`: 验证码ID，16个字符
- `captcha_code`: 用户输入的验证码，1-8个字符

**响应格式**:
```json
{
  "token": "jwt_token_string",  // string: JWT令牌
  "message": "success"  // string: 操作结果信息
}
```

**错误响应**:
- `400 Bad Request`: 验证码错误
  ```json
  {
    "error": "captcha_error"
  }
  ```
- `404 Not Found`: 用户不存在
  ```json
  {
    "error": "not_found" 
  }
  ```
- `401 Unauthorized`: 密码错误
  ```json
  {
    "error": "authentication_failed"
  }
  ```
- `422 Unprocessable Entity`: 请求JSON格式错误
  ```json
  {
    "error": "invalid_json"
  }
  ```

**说明**:
该接口首先验证验证码是否正确，然后验证用户凭证。如果成功，将返回JWT令牌，客户端应在后续请求中使用该令牌进行认证，将其放在请求头的Authorization字段中，格式为"Bearer {token}"。

### 2. 用户注册接口

#### 2.1 注册管理员用户

- **URL**: `/register/admin`
- **方法**: `POST`
- **描述**: 注册一个新的管理员用户
- **权限**: 需要管理员权限

**请求格式**:
```json
{
  "username": "new_admin",
  "password_hash": "hashed_password_string",
  "captcha_id": "16_character_id",
  "captcha_code": "user_input_captcha"
}
```

**请求字段说明**:
- `username`: 用户名，长度4-20个字符
- `password_hash`: 密码哈希（前端计算的密码哈希值）
- `captcha_id`: 验证码ID，16个字符
- `captcha_code`: 用户输入的验证码，1-8个字符

**响应格式**:
```json
{
  "token": "jwt_token_string",
  "message": "hello JWT"
}
```

**错误响应**:
- `401 Unauthorized`: 认证失败或当前用户不是管理员
  ```json
  {
    "error": "authentication_failed"
  }
  ```
- `403 Forbidden`: 权限不足
  ```json
  {
    "error": "forbidden"
  }
  ```
- `409 Conflict`: 用户名已存在
  ```json
  {
    "error": "username_exists"
  }
  ```
- `422 Unprocessable Entity`: 请求JSON格式错误
  ```json
  {
    "error": "invalid_json"
  }
  ```

**说明**:
此接口仅限已经是管理员的用户调用，用于创建新的管理员账号。注册成功后会返回一个JWT令牌。

#### 2.2 注册高级用户

- **URL**: `/register/senior`
- **方法**: `POST`
- **描述**: 注册一个新的高级用户
- **权限**: 无需认证

**请求格式**:
```json
{
  "username": "new_senior_user",
  "password_hash": "hashed_password_string",
  "captcha_id": "16_character_id",
  "captcha_code": "user_input_captcha"
}
```

**请求字段说明**:
- `username`: 用户名，长度4-20个字符
- `password_hash`: 密码哈希（前端计算的密码哈希值）
- `captcha_id`: 验证码ID，16个字符
- `captcha_code`: 用户输入的验证码，1-8个字符

**响应格式**:
```json
{
  "token": "jwt_token_string",
  "message": "注册成功"
}
```

**错误响应**:
- `400 Bad Request`: 验证码错误或输入验证失败
  ```json
  {
    "error": "captcha_error"
  }
  ```
  或
  ```json
  {
    "error": "validation_error"
  }
  ```
- `409 Conflict`: 用户名已存在
  ```json
  {
    "error": "username_exists"
  }
  ```
- `422 Unprocessable Entity`: 请求JSON格式错误
  ```json
  {
    "error": "invalid_json"
  }
  ```

**说明**:
注册高级用户需要先通过验证码验证，然后进行用户创建。注册成功后会返回JWT令牌。

#### 2.3 注册普通用户

- **URL**: `/register/normal`
- **方法**: `POST`
- **描述**: 注册一个新的普通用户
- **权限**: 无需认证

**请求格式**:
```json
{
  "username": "new_normal_user",
  "password_hash": "hashed_password_string",
  "captcha_id": "16_character_id",
  "captcha_code": "user_input_captcha"
}
```

**请求字段说明**:
- `username`: 用户名，长度4-20个字符
- `password_hash`: 密码哈希（前端计算的密码哈希值）
- `captcha_id`: 验证码ID，16个字符
- `captcha_code`: 用户输入的验证码，1-8个字符

**响应格式**:
```json
{
  "token": "jwt_token_string",
  "message": "注册成功"
}
```

**错误响应**:
- `400 Bad Request`: 验证码错误或输入验证失败
  ```json
  {
    "error": "captcha_error"
  }
  ```
  或
  ```json
  {
    "error": "validation_error"
  }
  ```
- `409 Conflict`: 用户名已存在
  ```json
  {
    "error": "username_exists"
  }
  ```
- `422 Unprocessable Entity`: 请求JSON格式错误
  ```json
  {
    "error": "invalid_json"
  }
  ```

**说明**:
注册普通用户需要先通过验证码验证，然后进行用户创建。注册成功后会返回JWT令牌。

### 3. 验证码接口

#### 3.1 生成验证码

- **URL**: `/captcha`
- **方法**: `GET`
- **权限**: 无需认证

**响应格式**:
```json
{
  "captcha_id": "1a2b3c4d5e6f7g8h",  // string: 验证码标识ID，16位字符
  "captcha_image": "data:image/png;base64,iVBORw0KG...",  // string: Base64编码的图片数据
  "message": "验证码生成成功"  // string: 操作结果信息
}
```

**错误响应**:
- `500 Internal Server Error`: 验证码生成失败

**说明**:
- 生成的验证码有效期为1分钟
- 验证码图片以Base64编码的PNG格式返回
- 验证码ID用于后续验证时关联验证码

### 4. 密码管理接口

#### 4.1 修改密码

- **URL**: `/password/change`
- **方法**: `POST`
- **权限**: 需要用户登录

**请求格式**:
```json
{
  "old_password_hash": "旧密码的哈希值",  // string: 至少6位
  "new_password_hash": "新密码的哈希值"   // string: 至少6位
}
```

**响应格式**:
```json
{
  "message": "密码修改成功"
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 用户未登录
- `403 Forbidden`: 旧密码不正确
- `500 Internal Server Error`: 服务器内部错误

#### 4.2 重置用户密码（管理员功能）

- **URL**: `/password/reset`
- **方法**: `POST`
- **权限**: 需要管理员权限

**请求格式**:
```json
{
  "target_user_uuid": "目标用户的UUID",  // string: 36位字符
  "new_password_hash": "新密码的哈希值"   // string: 至少6位
}
```

**响应格式**:
```json
{
  "message": "用户密码重置成功"
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 无管理员权限
- `404 Not Found`: 目标用户不存在
- `500 Internal Server Error`: 服务器内部错误

### 5. 邀请码接口

#### 5.1 生成邀请码

- **URL**: `/invite/generate`
- **方法**: `GET`
- **权限**: 需要用户登录

**响应格式**:
```json
{
  "invite_code": "A1B2C3D4",  // string: 8位邀请码
  "message": "邀请码生成成功"
}
```

**错误响应**:
- `401 Unauthorized`: 用户未登录
- `403 Forbidden`: 没有生成邀请码的权限
- `500 Internal Server Error`: 服务器内部错误

#### 5.2 使用邀请码

- **URL**: `/invite/use`
- **方法**: `POST`
- **权限**: 需要用户登录

**请求格式**:
```json
{
  "invite_code": "A1B2C3D4"  // string: 邀请码
}
```

**响应格式**:
```json
{
  "invite_code": "A1B2C3D4",
  "message": "邀请码使用成功"
}
```

**错误响应**:
- `400 Bad Request`: 邀请码格式无效
- `401 Unauthorized`: 用户未登录
- `404 Not Found`: 邀请码不存在或已过期
- `500 Internal Server Error`: 服务器内部错误

#### 5.3 验证邀请码

- **URL**: `/invite/validate`
- **方法**: `POST`
- **权限**: 无需认证

**请求格式**:
```json
{
  "invite_code": "A1B2C3D4"  // string: 邀请码
}
```

**响应格式**:
```json
{
  "message": "邀请码有效"  // string: 邀请码有效或已过期
}
```

**错误响应**:
- `400 Bad Request`: 邀请码格式无效
- `500 Internal Server Error`: 服务器内部错误

### 6. 账户管理接口

#### 6.1 注销账户

- **URL**: `/account/delete`
- **方法**: `DELETE`
- **权限**: 需要用户登录

**请求格式**:
```json
{
  "password_hash": "密码的哈希值"  // string: 至少128位字符
}
```

**响应格式**:
```json
{
  "message": "账号注销成功"
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 用户未登录或密码错误
- `500 Internal Server Error`: 服务器内部错误

#### 6.2 管理员强制注销用户

- **URL**: `/account/admin/delete`
- **方法**: `DELETE`
- **权限**: 需要管理员权限

**请求格式**:
```json
{
  "target_user_uuid": "目标用户的UUID"  // string: 36位字符
}
```

**响应格式**:
```json
{
  "message": "用户账号已强制注销"
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 无管理员权限
- `404 Not Found`: 目标用户不存在
- `500 Internal Server Error`: 服务器内部错误

#### 6.3 高级用户移除普通用户

- **URL**: `/account/senior/remove`
- **方法**: `POST`
- **权限**: 需要高级用户权限

**请求格式**:
```json
{
  "normal_user_uuid": "普通用户的UUID"  // string: 36位字符
}
```

**响应格式**:
```json
{
  "message": "已成功移除该普通用户"
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 无高级用户权限或目标不是普通用户
- `404 Not Found`: 目标用户不存在
- `500 Internal Server Error`: 服务器内部错误

### 7. 设备管理接口

#### 7.1 高级用户注册设备

- **URL**: `/device/register`
- **方法**: `POST`
- **权限**: 需要高级用户权限

**请求格式**:
```json
{
  "device_uuid": "设备唯一标识符"  // string: 设备ID，不能为空
}
```

**请求字段说明**:
- `device_uuid`: 设备ID，不能为空

**响应格式**:
```json
{
  "message": "设备注册成功"  // string: 操作结果信息
}
```

**错误响应**:
- `400 Bad Request`: 设备ID为空或格式无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非高级用户
- `409 Conflict`: 设备已被注册
- `500 Internal Server Error`: 服务器内部错误

#### 7.2 高级用户注销设备

- **URL**: `/device/unregister`
- **方法**: `DELETE`
- **权限**: 需要高级用户权限

**请求格式**:
```json
{
  "device_uuid": "设备唯一标识符"  // string: 设备ID，不能为空
}
```

**请求字段说明**:
- `device_uuid`: 设备ID，不能为空

**响应格式**:
```json
{
  "message": "设备注销成功"
}
```

**错误响应**:
- `400 Bad Request`: 设备ID为空或格式无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非高级用户或您不是该设备的所有者
- `404 Not Found`: 设备不存在
- `500 Internal Server Error`: 服务器内部错误

#### 7.3 管理员为高级用户注册设备

- **URL**: `/device/admin/register`
- **方法**: `POST`
- **权限**: 需要管理员权限

**请求格式**:
```json
{
  "user_uuid": "高级用户UUID",  // string: 高级用户的UUID，长度至少为36个字符
  "device_uuid": "设备唯一标识符"  // string: 设备ID，不能为空
}
```

**请求字段说明**:
- `user_uuid`: 高级用户的UUID，长度至少为36个字符
- `device_uuid`: 设备ID，不能为空

**响应格式**:
```json
{
  "message": "管理员成功为高级用户注册设备"
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员或目标用户非高级用户
- `404 Not Found`: 用户不存在
- `409 Conflict`: 设备已被注册
- `500 Internal Server Error`: 服务器内部错误

#### 7.4 管理员为高级用户注销设备

- **URL**: `/device/admin/unregister`
- **方法**: `DELETE`
- **权限**: 需要管理员权限

**请求格式**:
```json
{
  "user_uuid": "高级用户UUID",  // string: 高级用户的UUID，长度至少为36个字符
  "device_uuid": "设备唯一标识符"  // string: 设备ID，不能为空
}
```

**请求字段说明**:
- `user_uuid`: 高级用户的UUID，长度至少为36个字符
- `device_uuid`: 设备ID，不能为空

**响应格式**:
```json
{
  "message": "管理员成功为高级用户注销设备"
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员或目标用户非高级用户或用户不是该设备的所有者
- `404 Not Found`: 用户或设备不存在
- `500 Internal Server Error`: 服务器内部错误

#### 7.5 高级用户查询自己的主设备

- **URL**: `/device/master`
- **方法**: `GET`
- **权限**: 需要高级用户权限

**响应格式**:
```json
[
  "设备ID1",  // string: 设备唯一标识符
  "设备ID2",  // string: 设备唯一标识符
  ...
]
```

**错误响应**:
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非高级用户
- `500 Internal Server Error`: 服务器内部错误

#### 7.6 普通用户查询所属高级用户的主设备

- **URL**: `/device/senior/master`
- **方法**: `GET`
- **权限**: 需要普通用户权限

**响应格式**:
```json
[
  "设备ID1",  // string: 设备唯一标识符
  "设备ID2",  // string: 设备唯一标识符
  ...
]
```

**错误响应**:
- `401 Unauthorized`: 未登录
- `404 Not Found`: 用户不存在或不属于任何高级用户
- `500 Internal Server Error`: 服务器内部错误

#### 7.7 高级用户查询主设备及其从设备

- **URL**: `/device/master/slaves`
- **方法**: `GET`
- **权限**: 需要高级用户权限

**响应格式**:
```json
[
  {
    "device_uuid": "主设备ID1",  // string: 主设备唯一标识符
    "slave_device_uuid": ["从设备ID1", "从设备ID2", ...]  // array<string>: 从设备唯一标识符列表
  },
  {
    "device_uuid": "主设备ID2",
    "slave_device_uuid": ["从设备ID3", "从设备ID4", ...]
  },
  ...
]
```

**错误响应**:
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非高级用户
- `500 Internal Server Error`: 服务器内部错误

#### 7.8 普通用户查询所属高级用户的主设备及其从设备

- **URL**: `/device/senior/master/slaves`
- **方法**: `GET`
- **权限**: 需要普通用户权限

**响应格式**:
```json
[
  {
    "device_uuid": "主设备ID1",
    "slave_device_uuid": ["从设备ID1", "从设备ID2", ...]
  },
  {
    "device_uuid": "主设备ID2",
    "slave_device_uuid": ["从设备ID3", "从设备ID4", ...]
  },
  ...
]
```

**错误响应**:
- `401 Unauthorized`: 未登录
- `404 Not Found`: 用户不存在或不属于任何高级用户
- `500 Internal Server Error`: 服务器内部错误

#### 7.9 管理员分页查询所有设备

- **URL**: `/device/admin/devices`
- **方法**: `GET`
- **权限**: 需要管理员权限

**查询参数**:
- `page`: 页码，可选，默认为1  // number: 整数
- `page_size`: 每页条数，可选，默认为10  // number: 整数

**响应格式**:
```json
[
  [
    {
      "device_uuid": "设备ID1",  // string: 设备唯一标识符
      "device_type": "master",  // string: 设备类型，"master"或"slave"
      "user_uuid": "所有者UUID"  // string: 用户唯一标识符
    },
    {
      "device_uuid": "设备ID2",
      "device_type": "slave",
      "user_uuid": "所有者UUID"
    },
    ...
  ],
  1,  // number: 当前页码
  10  // number: 总页数
]
```

**错误响应**:
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员
- `500 Internal Server Error`: 服务器内部错误

#### 7.10 高级用户查询在线主设备

- **URL**: `/device/master/online`
- **方法**: `GET`
- **权限**: 需要高级用户权限

**响应格式**:
```json
[
  {
    "device_uuid": "设备ID1",  // string: 设备唯一标识符
    "is_online": true,  // boolean: 是否在线
    "time": "2023-04-25T12:34:56Z"  // string: ISO格式的时间戳
  },
  {
    "device_uuid": "设备ID2",
    "is_online": false,
    "time": "2023-04-25T10:30:00Z"
  },
  ...
]
```

**错误响应**:
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非高级用户
- `500 Internal Server Error`: 服务器内部错误

#### 7.11 管理员查询指定高级用户的在线设备

- **URL**: `/device/admin/devices/online`
- **方法**: `GET`
- **权限**: 需要管理员权限

**查询参数**:
- `senior_uuid`: 高级用户UUID  // string: UUID格式

**响应格式**:
```json
[
  {
    "device_uuid": "设备ID1",
    "is_online": true,
    "time": "2023-04-25T12:34:56Z"
  },
  {
    "device_uuid": "设备ID2",
    "is_online": false,
    "time": "2023-04-25T10:30:00Z"
  },
  ...
]
```

**错误响应**:
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员
- `500 Internal Server Error`: 服务器内部错误

### 8. 传感器数据接口

#### 8.1 管理员获取设备传感器数据

- **URL**: `/admin/device-sensor-data`
- **方法**: `GET`
- **权限**: 需要管理员权限

**查询参数**:
- `device_uuid`: 设备ID，必填  // string: 设备ID，不能为空
- `page`: 页码，可选，默认为1  // number: 整数
- `page_size`: 每页条数，可选，默认为10  // number: 整数

**响应格式**:
```json
{
  "device_uuid": "设备ID",  // string: 设备唯一标识符
  "raw_data": [
    {"temperature": 25.5, "humidity": 60},  // object: JSON格式的原始数据
    {"temperature": 26.0, "humidity": 58},
    // ...更多数据
  ],
  "current_page": 1,  // number: 当前页码
  "total_pages": 10,  // number: 总页数
  "total_items": 100  // number: 总条目数
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员
- `500 Internal Server Error`: 服务器内部错误

#### 8.2 高级用户获取自己设备的传感器数据

- **URL**: `/senior/device-sensor-data`
- **方法**: `GET`
- **权限**: 需要高级用户权限

**查询参数**:
- `device_uuid`: 设备ID，必填  // string: 设备ID，不能为空
- `page`: 页码，可选，默认为1  // number: 整数
- `page_size`: 每页条数，可选，默认为10  // number: 整数

**响应格式**:
```json
{
  "device_uuid": "设备ID",
  "raw_data": [
    {"temperature": 25.5, "humidity": 60},
    {"temperature": 26.0, "humidity": 58},
    // ...更多数据
  ],
  "current_page": 1,
  "total_pages": 5,
  "total_items": 50
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非高级用户或设备不属于该用户
- `500 Internal Server Error`: 服务器内部错误

#### 8.3 普通用户获取所属高级用户的设备传感器数据

- **URL**: `/user/device-sensor-data`
- **方法**: `GET`
- **权限**: 需要普通用户权限

**查询参数**:
- `device_uuid`: 设备ID，必填  // string: 设备ID，不能为空
- `page`: 页码，可选，默认为1  // number: 整数
- `page_size`: 每页条数，可选，默认为10  // number: 整数

**响应格式**:
```json
{
  "device_uuid": "设备ID",
  "raw_data": [
    {"temperature": 25.5, "humidity": 60},
    {"temperature": 26.0, "humidity": 58},
    // ...更多数据
  ],
  "current_page": 1,
  "total_pages": 5,
  "total_items": 50
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 设备不属于所属高级用户
- `404 Not Found`: 用户不存在或不属于任何高级用户
- `500 Internal Server Error`: 服务器内部错误

### 9. 事件日志接口

#### 9.1 管理员按设备ID获取事件日志

- **URL**: `/admin/device-event-logs`
- **方法**: `GET`
- **权限**: 需要管理员权限

**查询参数**:
- `device_uuid`: 设备ID，必填  // string: 设备ID，不能为空
- `page`: 页码，可选，默认为1  // number: 整数
- `page_size`: 每页条数，可选，默认为10  // number: 整数
- `event_type`: 事件类型，可选，值为"alert"或"log"  // string: 按事件类型筛选

**响应格式**:
```json
{
  "data": [
    {
      "log_uuid": "日志ID",  // string: 日志唯一标识符
      "event_type": "事件类型",  // string: 事件类型名称
      "device_uuid": "设备ID",  // string: 设备唯一标识符，可能为null
      "user_uuid": "用户ID",  // string: 用户唯一标识符，可能为null
      "details": "事件详情",  // string: 详细事件信息
      "timestamp": "2023-04-25T12:34:56Z"  // string: ISO格式的时间戳
    },
    ...
  ],
  "current_page": 1,  // number: 当前页码
  "total_pages": 10,  // number: 总页数
  "total_items": 100  // number: 总条目数
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效或事件类型不正确
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员
- `500 Internal Server Error`: 服务器内部错误

#### 9.2 高级用户按设备ID获取事件日志

- **URL**: `/senior/device-event-logs`
- **方法**: `GET`
- **权限**: 需要高级用户权限

**查询参数**:
- `device_uuid`: 设备ID，必填  // string: 设备ID，不能为空
- `page`: 页码，可选，默认为1  // number: 整数
- `page_size`: 每页条数，可选，默认为10  // number: 整数
- `event_type`: 事件类型，可选，值为"alert"或"log"  // string: 按事件类型筛选

**响应格式**:
```json
{
  "data": [
    {
      "log_uuid": "日志ID",
      "event_type": "事件类型",
      "device_uuid": "设备ID",
      "user_uuid": "用户ID",
      "details": "事件详情",
      "timestamp": "2023-04-25T12:34:56Z"
    },
    ...
  ],
  "current_page": 1,
  "total_pages": 5,
  "total_items": 50
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效或事件类型不正确
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非高级用户或设备不属于该用户
- `500 Internal Server Error`: 服务器内部错误

#### 9.3 普通用户按设备ID获取事件日志

- **URL**: `/user/device-event-logs`
- **方法**: `GET`
- **权限**: 需要普通用户权限

**查询参数**:
- `device_uuid`: 设备ID，必填  // string: 设备ID，不能为空
- `page`: 页码，可选，默认为1  // number: 整数
- `page_size`: 每页条数，可选，默认为10  // number: 整数
- `event_type`: 事件类型，可选，值为"alert"或"log"  // string: 按事件类型筛选

**响应格式**:
```json
{
  "data": [
    {
      "log_uuid": "日志ID",
      "event_type": "事件类型",
      "device_uuid": "设备ID",
      "user_uuid": "用户ID",
      "details": "事件详情",
      "timestamp": "2023-04-25T12:34:56Z"
    },
    ...
  ],
  "current_page": 1,
  "total_pages": 5,
  "total_items": 50
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效或事件类型不正确
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 设备不属于所属高级用户
- `404 Not Found`: 用户不存在或不属于任何高级用户
- `500 Internal Server Error`: 服务器内部错误

### 10. 系统信息接口

#### 10.1 获取用户名

- **URL**: `/`
- **方法**: `GET`
- **权限**: 需要用户登录

**响应格式**:
```
"用户名"  // string: 当前登录用户的用户名
```

**错误响应**:
- `401 Unauthorized`: 未登录
- `404 Not Found`: 用户不存在
- `500 Internal Server Error`: 服务器内部错误

### 11. 管理员接口

#### 11.1 分页查询所有用户

- **URL**: `/admin/users`
- **方法**: `GET`
- **权限**: 需要管理员权限

**查询参数**:
- `page`: 页码，必填，最小值为1  // number: 整数
- `page_size`: 每页条数，必填，范围为1-100  // number: 整数

**响应格式**:
```json
{
  "users": [
    {
      "user_uuid": "用户UUID",  // string: UUID格式
      "username": "用户名",  // string
      "user_type": "用户类型"  // string
    },
    ...
  ],
  "total_pages": 10,  // number: 总页数
  "current_page": 1  // number: 当前页码
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员
- `500 Internal Server Error`: 服务器内部错误

#### 11.2 修改用户信息

- **URL**: `/admin/users`
- **方法**: `PUT`
- **权限**: 需要管理员权限

**请求格式**:
```json
{
  "user_uuid": "目标用户UUID",  // string: UUID格式
  "username": "新用户名",  // string
  "password_hash": "新密码哈希",  // string
  "user_type": "新用户类型",  // string
  "manager_uuid": null  // string或null: UUID格式
}
```

**请求字段说明**:
- `user_uuid`: 目标用户UUID，必填  // string: UUID格式
- `username`: 新用户名，可选，长度3-20个字符  // string
- `password_hash`: 新密码哈希，可选  // string
- `user_type`: 新用户类型，可选，必须是"admin"、"senior"或"normal"之一  // string
- `manager_uuid`: 管理者UUID，可选，如果是普通用户，可以指定其所属的高级用户UUID  // string或null: UUID格式

**响应格式**:
```json
{
  "message": "用户信息修改成功"
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员
- `404 Not Found`: 用户不存在
- `500 Internal Server Error`: 服务器内部错误

#### 11.3 删除用户

- **URL**: `/admin/users`
- **方法**: `DELETE`
- **权限**: 需要管理员权限

**请求格式**:
```json
{
  "user_uuid": "目标用户UUID"  // string: UUID格式
}
```

**响应格式**:
```json
{
  "message": "用户删除成功"
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员
- `404 Not Found`: 用户不存在
- `500 Internal Server Error`: 服务器内部错误

#### 11.4 批量删除用户

- **URL**: `/admin/users/batch`
- **方法**: `DELETE`
- **权限**: 需要管理员权限

**请求格式**:
```json
{
  "user_uuids": ["用户UUID1", "用户UUID2", ...]  // array<string>: UUID格式的用户ID列表
}
```

**请求字段说明**:
- `user_uuids`: 用户UUID列表，至少包含一个元素  // array<string>: UUID格式的用户ID列表

**响应格式**:
```json
{
  "deleted_count": 2,  // number: 成功删除的用户数量
  "message": "成功删除2个用户"  // string: 操作结果信息
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效或用户列表为空
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员
- `500 Internal Server Error`: 服务器内部错误

#### 11.5 按用户名查询用户

- **URL**: `/admin/users/username`
- **方法**: `POST`
- **权限**: 需要管理员权限

**请求格式**:
```json
{
  "username": "要查询的用户名"  // string: 用户名，长度3-20个字符
}
```

**请求字段说明**:
- `username`: 用户名，长度3-20个字符

**响应格式**:
```json
{
  "user_uuid": "用户UUID",  // string: UUID格式
  "username": "用户名",  // string
  "user_type": "用户类型"  // string
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员
- `404 Not Found`: 用户不存在
- `500 Internal Server Error`: 服务器内部错误

#### 11.6 按用户UUID查询用户

- **URL**: `/admin/users/useruuid`
- **方法**: `POST`
- **权限**: 需要管理员权限

**请求格式**:
```json
{
  "user_uuid": "要查询的用户UUID"  // string: UUID格式
}
```

**响应格式**:
```json
{
  "user_uuid": "用户UUID",  // string: UUID格式
  "username": "用户名",  // string
  "user_type": "用户类型"  // string
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员
- `404 Not Found`: 用户不存在
- `500 Internal Server Error`: 服务器内部错误

#### 11.7 分页查询邀请码

- **URL**: `/admin/invite-codes`
- **方法**: `GET`
- **权限**: 需要管理员权限

**查询参数**:
- `page`: 页码，必填，最小值为1  // number: 整数
- `page_size`: 每页条数，必填，范围为1-100  // number: 整数

**响应格式**:
```json
{
  "invite_codes": [
    {
      "code": "邀请码",  // string: 8位邀请码
      "senior_uuid": "高级用户UUID",  // string: UUID格式
      "expires_in": 3600  // number: 过期时间（秒）
    },
    ...
  ],
  "total_pages": 5,  // number: 总页数
  "current_page": 1  // number: 当前页码
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员
- `500 Internal Server Error`: 服务器内部错误

#### 11.8 批量删除邀请码

- **URL**: `/admin/invite-codes/batch`
- **方法**: `DELETE`
- **权限**: 需要管理员权限

**请求格式**:
```json
{
  "invite_codes": ["邀请码1", "邀请码2", ...]  // array<string>: 邀请码列表，至少包含一个元素
}
```

**请求字段说明**:
- `invite_codes`: 邀请码列表，至少包含一个元素  // array<string>: 邀请码列表，至少包含一个元素

**响应格式**:
```json
{
  "deleted_count": 2,  // number: 成功删除的邀请码数量
  "message": "成功删除2个邀请码"  // string: 操作结果信息
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效或邀请码列表为空
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员
- `500 Internal Server Error`: 服务器内部错误

### 12. 农业文章接口

#### 12.1 获取文章列表

- **URL**: `/articles`
- **方法**: `GET`
- **权限**: 需要用户登录

**查询参数**:
- `page`: 页码，可选，默认为1  // number: 整数
- `page_size`: 每页条数，可选，默认为10，最大为100  // number: 整数

**响应格式**:
```json
{
  "data": [
    {
      "article_id": 1,
      "author_uuid": "作者UUID",
      "author_name": "作者用户名",
      "title": "文章标题",
      "created_at": "2023-04-25T12:34:56Z"
    },
    ...
  ],
  "current_page": 1,
  "total_pages": 5,
  "total_items": 50
}
```

**错误响应**:
- `401 Unauthorized`: 未登录
- `500 Internal Server Error`: 服务器内部错误

#### 12.2 获取文章详情

- **URL**: `/articles/{article_id}`
- **方法**: `GET`
- **权限**: 需要用户登录

**URL参数**:
- `article_id`: 文章ID，整数  // number

**响应格式**:
```json
{
  "article_id": 1,  // number: 文章ID
  "author_uuid": "作者UUID",  // string: UUID格式
  "author_name": "作者用户名",  // string
  "title": "文章标题",  // string
  "content": "文章内容",  // string
  "created_at": "2023-04-25T12:34:56Z"  // string: ISO格式的时间戳
}
```

**错误响应**:
- `401 Unauthorized`: 未登录
- `404 Not Found`: 文章不存在
- `500 Internal Server Error`: 服务器内部错误

#### 12.3 添加文章（管理员）

- **URL**: `/admin/articles`
- **方法**: `POST`
- **权限**: 需要管理员权限

**请求格式**:
```json
{
  "title": "文章标题",
  "content": "文章内容"
}
```

**请求字段说明**:
- `title`: 文章标题，长度1-200个字符  // string: 文章标题，长度1-200个字符
- `content`: 文章内容，不能为空  // string: 文章内容，不能为空

**响应格式**:
```json
{
  "article_id": 1,
  "message": "文章添加成功"
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员
- `500 Internal Server Error`: 服务器内部错误

#### 12.4 更新文章（管理员）

- **URL**: `/admin/articles/{article_id}`
- **方法**: `PUT`
- **权限**: 需要管理员权限

**URL参数**:
- `article_id`: 文章ID，整数  // number

**请求格式**:
```json
{
  "title": "新的文章标题",
  "content": "新的文章内容"
}
```

**请求字段说明**:
- `title`: 文章标题，长度1-200个字符  // string: 文章标题，长度1-200个字符
- `content`: 文章内容，不能为空  // string: 文章内容，不能为空

**响应格式**:
```json
{
  "article_id": 1,
  "author_uuid": "作者UUID",
  "author_name": "作者用户名",
  "title": "新的文章标题",
  "content": "新的文章内容",
  "created_at": "2023-04-25T12:34:56Z",
  "message": "文章更新成功"
}
```

**错误响应**:
- `400 Bad Request`: 请求参数无效
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员
- `404 Not Found`: 文章不存在
- `500 Internal Server Error`: 服务器内部错误

#### 12.5 删除文章（管理员）

- **URL**: `/admin/articles/{article_id}`
- **方法**: `DELETE`
- **权限**: 需要管理员权限

**URL参数**:
- `article_id`: 文章ID，整数  // number

**响应格式**:
```json
{
  "article_id": 1,
  "message": "文章删除成功"
}
```

**错误响应**:
- `401 Unauthorized`: 未登录
- `403 Forbidden`: 非管理员
- `404 Not Found`: 文章不存在
- `500 Internal Server Error`: 服务器内部错误 